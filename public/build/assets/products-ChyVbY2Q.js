document.addEventListener("DOMContentLoaded",function(){const g=document.getElementById("product_type"),S=document.getElementById("simple-product"),A=document.getElementById("variable-product"),k=document.getElementById("name"),B=document.getElementById("simple_sku"),$=document.getElementById("variable_sku"),x=document.getElementById("simple_slug"),L=document.getElementById("variable_slug"),p=document.getElementById("attributes-container"),f=document.getElementById("add-attribute"),w=document.getElementById("generate-variations"),m=document.getElementById("variations-container"),h=document.getElementById("set-variations-price"),C=window.colors||[],I=window.sizes||[],V=window.spherical_values||[],R=window.cylindrical_values||[];function N(t,n=""){const e=Date.now(),r=t.toLowerCase().replace(/[^a-z0-9\s]/g,"").replace(/\s+/g,"-")||"product",i=`${n}${r}-${e}`,u=`${n}${r}-${e}`;return{sku:i,slug:u}}if(k&&B&&x&&$&&L&&k.addEventListener("input",function(){const{sku:t,slug:n}=N(this.value);B.value=t,x.value=n,$.value=`VAR-${t}`,L.value=`var-${n}`}),g){let t=function(){if(g.value==="simple")S.style.display="block",A.style.display="none";else{S.style.display="none",A.style.display="block";const{sku:n,slug:e}=N(k.value||"product","VAR-");$.value=n,L.value=`var-${e}`}};var _=t;g.addEventListener("change",t),t()}document.querySelectorAll(".price-input").forEach(t=>{t.addEventListener("input",function(n){let e=n.target.value.replace(/[^0-9,.]/g,"");e.includes(",")&&(e=e.replace(",",".")),e.split(".").length>2&&(e=e.replace(/\.+$/,"")),n.target.value=e}),t.addEventListener("blur",function(n){n.target.value===""&&(n.target.value="0")})}),f&&p&&f.addEventListener("click",function(){const t=p.getElementsByClassName("attribute-row");if(t.length>=4){f.style.display="none";return}const n=Array.from(t).map(l=>{var c;return((c=l.querySelector(".attribute-type"))==null?void 0:c.value)||""}),e=t.length,r=["color","size","spherical","cylindrical"].filter(l=>!n.includes(l));if(r.length===0)return;const i=document.createElement("div");i.className="attribute-row row g-2 mb-2",i.setAttribute("data-index",e),i.innerHTML=`
                <div class="col-md-3">
                    <select name="attributes[${e}][type]" class="form-select attribute-type" data-index="${e}">
                        ${r.map(l=>`<option value="${l}">${l==="color"?"Màu sắc":l==="size"?"Kích thước":l==="spherical"?"Độ cận":"Độ loạn"}</option>`).join("")}
                    </select>
                </div>
                <div class="col-md-6">
                    <div class="attribute-values-tags"></div>
                    <div class="border rounded p-3 attribute-values-container" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger btn-sm remove-attribute">Xóa</button>
                </div>
            `,p.appendChild(i);const u=i.querySelector(".attribute-type"),o=i.querySelector(".attribute-values-tags"),a=i.querySelector(".attribute-values-container");function s(l,c){a.innerHTML="";const d=l==="color"?C:l==="size"?I:l==="spherical"?V:R;if(d.length===0){a.innerHTML='<p class="text-muted">Không có giá trị nào để chọn.</p>';return}d.forEach(v=>{const y=document.createElement("div");y.className="form-check",y.innerHTML=`
                        <input type="checkbox" class="form-check-input attribute-value-checkbox"
                            name="attributes[${c}][values][]"
                            value="${v}"
                            data-index="${c}">
                        <label class="form-check-label">${v}</label>
                    `,a.appendChild(y)})}u.addEventListener("change",function(){const l=this.closest(".attribute-row").getAttribute("data-index");s(this.value,l),E()}),a.addEventListener("change",function(l){if(l.target.classList.contains("attribute-value-checkbox")){const c=l.target.getAttribute("data-index"),d=Array.from(a.querySelectorAll(`input[name="attributes[${c}][values][]"]:checked`)).map(v=>v.value);o.innerHTML="",d.forEach(v=>{const y=document.createElement("span");y.className="tag",y.innerHTML=`${v}<input type="hidden" name="attributes[${c}][values][]" value="${v}"><button type="button" class="remove-tag" data-value="${v}">×</button>`,o.appendChild(y)}),E(),b()}}),o.addEventListener("click",function(l){if(l.target.classList.contains("remove-tag")){const c=l.target.getAttribute("data-value"),d=a.querySelector(`input[value="${c}"]`);d&&(d.checked=!1),l.target.parentElement.remove(),E(),b()}}),i.querySelector(".remove-attribute").addEventListener("click",function(){i.remove(),E(),b(),T()}),s(u.value,e),b()});function T(){const t=p.getElementsByClassName("attribute-row"),n=Array.from(t).map(r=>{var i;return((i=r.querySelector(".attribute-type"))==null?void 0:i.value)||""}),e=["color","size","spherical","cylindrical"];Array.from(t).forEach((r,i)=>{const u=r.querySelector(".attribute-type"),o=u.value,a=e.filter(s=>!n.includes(s)||s===o);u.innerHTML=a.map(s=>`<option value="${s}" ${s===o?"selected":""}>${s==="color"?"Màu sắc":s==="size"?"Kích thước":s==="spherical"?"Độ cận":"Độ loạn"}</option>`).join(""),r.setAttribute("data-index",i),updateValuesContainer(u.value,i)})}function b(){if(!p)return;const t=p.getElementsByClassName("attribute-row"),n=Array.from(t).map(e=>{var r;return((r=e.querySelector(".attribute-type"))==null?void 0:r.value)||""});t.length>=4||n.includes("color")&&n.includes("size")&&n.includes("spherical")&&n.includes("cylindrical")?f.style.display="none":f.style.display="block"}function E(){if(!p||!w)return;const t=p.getElementsByClassName("attribute-row");let n=!1;for(let e of t)if(e.querySelectorAll(".tag").length>0){n=!0;break}w.style.display=n?"block":"none",m.style.display=n&&m.children.length>0?"block":"none"}function q(t){if(t.length===0)return[[]];const n=t[0],e=t.slice(1),r=q(e),i=[];for(let u of n.values)for(let o of r)i.push([u.trim(),...o.map(a=>a.trim())]);return i}function M(t,n,e){const i=Array.from(t.getElementsByClassName("attribute-row")).map(a=>{const s=a.querySelector(".attribute-type");if(!s)return null;const l=s.value,c=Array.from(a.querySelectorAll(".attribute-value-checkbox:checked")).map(d=>d.value.trim());return c.length?{type:l,values:c}:null}).filter(a=>a);if(!i.length){alert("Vui lòng chọn ít nhất một giá trị cho một thuộc tính!");return}const u=Array.from(n.getElementsByClassName("variation-row")).map(a=>{var s;return(s=a.querySelector('input[name$="[name]"]'))==null?void 0:s.value.trim()}).filter(a=>a),o=q(i).map(a=>a.join(" - ")).filter(a=>!u.includes(a));if(!o.length){alert("Không có tổ hợp biến thể mới để tạo.");return}n.style.display="block",h&&(h.style.display="block"),o.forEach((a,s)=>{const l=n.getElementsByClassName("variation-row").length,c=(e==null?void 0:e.value.trim())||"VAR",d=document.createElement("div");d.className="variation-row row g-2 mb-2",d.innerHTML=`
                <div class="col-md-2">
                    <input type="text" name="variations[${l}][name]" value="${a}" class="form-control" placeholder="Tên biến thể" readonly>
                </div>
                <div class="col-md-1">
                    <input type="text" name="variations[${l}][sku]" value="${c}-${a.toLowerCase().replace(/\s+/g,"-")}" class="form-control" placeholder="Mã sản phẩm">
                </div>
                <div class="col-md-1">
                    <input type="text" class="form-control price-input" name="variations[${l}][price]" value="" placeholder="Nhập giá (VD: 1000 hoặc 234.56)">
                </div>
                <div class="col-md-1">
                    <input type="text" class="form-control price-input" name="variations[${l}][sale_price]" value="" placeholder="Nhập giá (VD: 900 hoặc 234.56)">
                </div>
                <div class="col-md-2">
                    <input type="file" name="variations[${l}][image]" class="form-control variation-image-input">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-danger btn-sm remove-variation">Xóa</button>
                </div>
            `,n.appendChild(d)})}w&&p&&m&&w.addEventListener("click",function(){M(p,m,$)}),document.addEventListener("click",function(t){if(t.target.classList.contains("remove-variation")){if(m.getElementsByClassName("variation-row").length<=1){alert("Bạn không thể xóa biến thể này vì sản phẩm phải có ít nhất một biến thể.");return}confirm("Bạn có chắc muốn xóa biến thể này?")&&(t.target.closest(".variation-row").remove(),m.style.display=m.children.length>0?"block":"none",h&&(h.style.display=m.children.length>0?"block":"none"))}}),document.querySelectorAll("form").forEach(t=>{t.addEventListener("submit",function(n){const e=t.querySelector('input[name="price"]'),r=t.querySelector('input[name="sale_price"]'),i=t.querySelectorAll('input[name^="variations"][name$="[price]"]'),u=t.querySelectorAll('input[name^="variations"][name$="[sale_price]"]');let o=!1;if((g==null?void 0:g.value)==="simple"&&e&&e.value){let a=e.value.replace(",",".");isNaN(parseFloat(a))||parseFloat(a)<0?(e.classList.add("is-invalid"),o=!0):(e.classList.remove("is-invalid"),e.value=parseFloat(a).toString())}[r,...i,...u].forEach(a=>{if(a&&a.value){let s=a.value.replace(",",".");isNaN(parseFloat(s))||parseFloat(s)<0?(a.classList.add("is-invalid"),o=!0):(a.classList.remove("is-invalid"),a.value=parseFloat(s).toString())}}),o&&(n.preventDefault(),alert("Vui lòng nhập giá hợp lệ (số dương)."))})}),h&&h.addEventListener("click",function(){const t=m.getElementsByClassName("variation-row");if(t.length===0){alert("Chưa có biến thể nào để thêm giá gốc.");return}const n=prompt("Nhập giá gốc cho tất cả biến thể (VD: 1000 hoặc 1234.56):");if(n===null)return;let e=n.replace(",",".").trim();if(!e||isNaN(parseFloat(e))||parseFloat(e)<0){alert("Vui lòng nhập giá gốc hợp lệ (số dương).");return}e=parseFloat(e).toString(),Array.from(t).forEach(r=>{const i=r.querySelector('input[name$="[price]"]');i&&(i.value=e,i.classList.remove("is-invalid"))})}),b(),E()});
