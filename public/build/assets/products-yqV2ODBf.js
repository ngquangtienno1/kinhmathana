document.addEventListener("DOMContentLoaded",function(){const S=document.getElementById("product_type"),z=document.getElementById("simple-product"),T=document.getElementById("variable-product"),M=document.getElementById("name"),D=document.getElementById("simple_sku"),x=document.getElementById("variable_sku"),H=document.getElementById("simple_slug"),C=document.getElementById("variable_slug"),h=document.getElementById("attributes-container"),B=document.getElementById("add-attribute"),I=document.getElementById("generate-variations"),m=document.getElementById("variations-container"),E=document.getElementById("set-variations-price"),$=document.getElementById("set-variations-sale-price"),F=window.colors||[],P=window.sizes||[];let N=window.spherical_values||[],A=window.cylindrical_values||[];typeof N[0]=="string"&&(N=N.map((t,n)=>({id:window.spherical_ids?window.spherical_ids[n]:t,name:t}))),typeof A[0]=="string"&&(A=A.map((t,n)=>({id:window.cylindrical_ids?window.cylindrical_ids[n]:t,name:t})));function j(t,n=""){const e=Date.now(),r=t.toLowerCase().replace(/[^a-z0-9\s]/g,"").replace(/\s+/g,"-")||"product",i=`${n}${r}-${e}`,o=`${n}${r}-${e}`;return{sku:i,slug:o}}if(M&&D&&H&&x&&C&&M.addEventListener("input",function(){const{sku:t,slug:n}=j(this.value);D.value=t,H.value=n,x.value=`VAR-${t}`,C.value=`var-${n}`}),S){let t=function(){if(S.value==="simple")z.style.display="block",T.style.display="none";else{z.style.display="none",T.style.display="block";const{sku:n,slug:e}=j("nameInput".value||"product","VAR-");x.value=n,C.value=`var-${e}`}};var Z=t;S.addEventListener("change",t),t()}document.querySelectorAll(".price-input").forEach(t=>{t.addEventListener("input",function(n){let e=n.target.value.replace(/[^0-9,.]/g,"");e.includes(",")&&(e=e.replace(",",".")),e.split(".").length>2&&(e=e.replace(/\.+$/,"")),n.target.value=e}),t.addEventListener("blur",function(n){n.target.value===""&&(n.target.value="0")})}),B&&h&&B.addEventListener("click",function(){const t=h.getElementsByClassName("attribute-row");if(t.length>=4){B.style.display="none";return}const n=Array.from(t).map(a=>{var l;return((l=a.querySelector(".attribute-type"))==null?void 0:l.value)||""}),e=t.length,r=["color","size","spherical","cylindrical"].filter(a=>!n.includes(a));if(r.length===0)return;const i=document.createElement("div");i.className="attribute-row row g-2 mb-2",i.setAttribute("data-index",e),i.innerHTML=`
                <div class="col-md-3">
                    <select name="attributes[${e}][type]" class="form-select attribute-type" data-index="${e}">
                        ${r.map(a=>`<option value="${a}">${a==="color"?"Màu sắc":a==="size"?"Kích thước":a==="spherical"?"Độ cận":"Độ loạn"}</option>`).join("")}
                    </select>
                </div>
                <div class="col-md-6">
                    <div class="attribute-values-tags"></div>
                    <div class="border rounded p-3 attribute-values-container" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger btn-sm remove-attribute">Xóa</button>
                </div>
            `,h.appendChild(i);const o=i.querySelector(".attribute-type"),u=i.querySelector(".attribute-values-tags"),v=i.querySelector(".attribute-values-container");function d(a,l){v.innerHTML="";const c=a==="color"?F:a==="size"?P:a==="spherical"?N:A;if(c.length===0){v.innerHTML='<p class="text-muted">Không có giá trị nào để chọn.</p>';return}c.forEach(s=>{const p=s.id!==void 0&&s.id!==null?String(s.id):"",f=s.name||s,y=document.createElement("div");y.className="form-check",y.innerHTML=`
                        <input type="checkbox" class="form-check-input attribute-value-checkbox"
                            name="attributes[${l}][values][]"
                            value="${p}"
                            data-index="${l}">
                        <label class="form-check-label">${f}</label>
                    `,v.appendChild(y)})}o.addEventListener("change",function(){const a=this.closest(".attribute-row").getAttribute("data-index");d(this.value,a),q()}),v.addEventListener("change",function(a){if(a.target.classList.contains("attribute-value-checkbox")){const l=a.target.getAttribute("data-index"),c=Array.from(v.querySelectorAll(`input[name="attributes[${l}][values][]"]:checked`)).map(s=>s.value);u.innerHTML="",c.forEach(s=>{var y,b,_,V;let p=s;o.value==="color"?p=((y=F.find(g=>g.id==s))==null?void 0:y.name)||s:o.value==="size"?p=((b=P.find(g=>g.id==s))==null?void 0:b.name)||s:o.value==="spherical"?p=((_=N.find(g=>g.id==s))==null?void 0:_.name)||s:o.value==="cylindrical"&&(p=((V=A.find(g=>g.id==s))==null?void 0:V.name)||s);const f=document.createElement("span");f.className="tag",f.innerHTML=`${p}<input type="hidden" name="attributes[${l}][values][]" value="${s}"><button type="button" class="remove-tag" data-value="${s}">×</button>`,u.appendChild(f)}),q(),L()}}),u.addEventListener("click",function(a){if(a.target.classList.contains("remove-tag")){const l=a.target.getAttribute("data-value"),c=v.querySelector(`input[value="${l}"]`);c&&(c.checked=!1),a.target.parentElement.remove(),q(),L()}}),i.querySelector(".remove-attribute").addEventListener("click",function(){i.remove(),q(),L(),W()}),d(o.value,e),L()});function W(){const t=h.getElementsByClassName("attribute-row"),n=Array.from(t).map(r=>{var i;return((i=r.querySelector(".attribute-type"))==null?void 0:i.value)||""}),e=["color","size","spherical","cylindrical"];Array.from(t).forEach((r,i)=>{const o=r.querySelector(".attribute-type"),u=o.value,v=e.filter(d=>!n.includes(d)||d===u);o.innerHTML=v.map(d=>`<option value="${d}" ${d===u?"selected":""}>${d==="color"?"Màu sắc":d==="size"?"Kích thước":d==="spherical"?"Độ cận":"Độ loạn"}</option>`).join(""),r.setAttribute("data-index",i),updateValuesContainer(o.value,i)})}function L(){if(!h)return;const t=h.getElementsByClassName("attribute-row"),n=Array.from(t).map(e=>{var r;return((r=e.querySelector(".attribute-type"))==null?void 0:r.value)||""});t.length>=4||n.includes("color")&&n.includes("size")&&n.includes("spherical")&&n.includes("cylindrical")?B.style.display="none":B.style.display="block"}function q(){if(!h||!I)return;const t=h.getElementsByClassName("attribute-row");let n=!1;for(let e of t)if(e.querySelectorAll(".tag").length>0){n=!0;break}I.style.display=n?"block":"none",m.style.display=n&&m.children.length>0?"block":"none",E&&(E.style.display=m.children.length>0?"block":"none"),$&&($.style.display=m.children.length>0?"block":"none")}function K(t){if(t.length===0)return[[]];const n=t[0],e=t.slice(1),r=K(e),i=[];for(let o of n.values)for(let u of r)i.push([{type:n.type,value:o.trim()},...u]);return i}function Y(t,n,e){const i=Array.from(t.getElementsByClassName("attribute-row")).map(a=>{const l=a.querySelector(".attribute-type");if(!l)return null;const c=l.value,s=Array.from(a.querySelectorAll(".attribute-value-checkbox:checked")).map(p=>p.value.trim());return s.length?{type:c,values:s}:null}).filter(a=>a);if(!i.length){alert("Vui lòng chọn ít nhất một giá trị cho một thuộc tính!");return}const o=K(i),u=o.map(a=>Array.isArray(a)?a.join(" - "):Object.values(a).join(" - ")),v=Array.from(n.getElementsByClassName("variation-row")).map(a=>{var l;return(l=a.querySelector('input[name$="[name]"]'))==null?void 0:l.value.trim()}).filter(a=>a),d=o.map((a,l)=>({combo:a,name:u[l]})).filter(({name:a})=>!v.includes(a));if(!d.length){alert("Không có tổ hợp biến thể mới để tạo.");return}n.style.display="block",E&&(E.style.display="block"),$&&($.style.display="block"),d.forEach(({combo:a},l)=>{const c=n.getElementsByClassName("variation-row").length,s=(e==null?void 0:e.value.trim())||"VAR";let p="",f="",y="",b="",_="",V="",g="",O="";a.forEach(k=>{var X,J,Q,U;k.type==="color"&&(p=k.value,_=((X=F.find(w=>String(w.id)==p))==null?void 0:X.name)||""),k.type==="size"&&(f=k.value,V=((J=P.find(w=>String(w.id)==f))==null?void 0:J.name)||""),k.type==="spherical"&&(y=k.value,g=((Q=N.find(w=>String(w.id)==y))==null?void 0:Q.name)||""),k.type==="cylindrical"&&(b=k.value,O=((U=A.find(w=>String(w.id)==b))==null?void 0:U.name)||"")});const G=[_,V,g,O].filter(Boolean).join(" - "),R=document.createElement("div");R.className="variation-row row g-2 mb-2",R.innerHTML=`
                <div class="col-md-2">
                    <input type="text" name="variations[${c}][name]" value="${G}" class="form-control" placeholder="Tên biến thể" readonly>
                    <input type="hidden" name="variations[${c}][color_id]" value="${p}">
                    <input type="hidden" name="variations[${c}][size_id]" value="${f}">
                    <input type="hidden" name="variations[${c}][spherical_id]" value="${y}">
                    <input type="hidden" name="variations[${c}][cylindrical_id]" value="${b}">
                </div>
                <div class="col-md-2">
                    <input type="text" name="variations[${c}][sku]" value="${s}-${G.toLowerCase().replace(/\s+/g,"-")}" class="form-control" placeholder="Mã sản phẩm">
                </div>
                <div class="col-md-1">
                    <input type="text" class="form-control price-input" name="variations[${c}][price]" value="" placeholder="Nhập giá (VD: 1000 hoặc 234.56)">
                </div>
                <div class="col-md-1">
                    <input type="text" class="form-control price-input" name="variations[${c}][sale_price]" value="" placeholder="Nhập giá (VD: 900 hoặc 234.56)">
                </div>
                <div class="col-md-2">
                    <input type="file" name="variations[${c}][image]" class="form-control variation-image-input">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-danger btn-sm remove-variation">Xóa</button>
                </div>
            `,n.appendChild(R)})}if(I&&h&&m){let t=function(){const n=m.getElementsByClassName("variation-row");if(!n.length)return;let e=null,r=null;for(;;){if(e=prompt("Nhập giá gốc cho tất cả biến thể (VD: 1000 hoặc 1234.56):",e||""),e===null)return;if(e=e.replace(",",".").trim(),!e||isNaN(parseFloat(e))||parseFloat(e)<0){alert("Vui lòng nhập giá gốc hợp lệ (số dương).");continue}break}for(;;){if(r=prompt("Nhập giá khuyến mãi cho tất cả biến thể (có thể bỏ trống):",r||""),r===null)return;if(r===""){r="";break}if(r=r.replace(",",".").trim(),!r||isNaN(parseFloat(r))||parseFloat(r)<0){alert("Vui lòng nhập giá khuyến mãi hợp lệ (số dương hoặc để trống).");continue}if(parseFloat(r)>parseFloat(e)){alert("Giá khuyến mãi không được lớn hơn giá gốc!");continue}break}Array.from(n).forEach(i=>{const o=i.querySelector('input[name$="[price]"]'),u=i.querySelector('input[name$="[sale_price]"]');o&&(o.value=e),u&&(u.value=r)})};var ee=t;I.addEventListener("click",function(){Y(h,m,x),setTimeout(()=>{t()},200)})}document.addEventListener("click",function(t){if(t.target.classList.contains("remove-variation")){if(m.getElementsByClassName("variation-row").length<=1){alert("Bạn không thể xóa biến thể này vì sản phẩm phải có ít nhất một biến thể.");return}confirm("Bạn có chắc muốn xóa biến thể này?")&&(t.target.closest(".variation-row").remove(),m.style.display=m.children.length>0?"block":"none",E&&(E.style.display=m.children.length>0?"block":"none"),$&&($.style.display=m.children.length>0?"block":"none"))}}),document.querySelectorAll("form").forEach(t=>{t.addEventListener("submit",function(n){const e=new FormData(t),r=(h==null?void 0:h.getElementsByClassName("attribute-row"))||[];Array.from(r).forEach((l,c)=>{l.querySelectorAll(".attribute-value-checkbox:checked").length===0&&l.querySelectorAll('[name^="attributes['+c+']"]').forEach(p=>{p.disabled=!0})});for(let[l,c]of e.entries());const i=t.querySelector('input[name="price"]'),o=t.querySelector('input[name="sale_price"]'),u=t.querySelectorAll('input[name^="variations"][name$="[price]"]'),v=t.querySelectorAll('input[name^="variations"][name$="[sale_price]"]');let d=!1;if((S==null?void 0:S.value)==="simple"&&i&&i.value){let l=i.value.replace(",",".");isNaN(parseFloat(l))||parseFloat(l)<0?(i.classList.add("is-invalid"),d=!0):(i.classList.remove("is-invalid"),i.value=parseFloat(l).toString())}[o,...u,...v].forEach(l=>{if(l&&l.value){let c=l.value.replace(",",".");isNaN(parseFloat(c))||parseFloat(c)<0?(l.classList.add("is-invalid"),d=!0):(l.classList.remove("is-invalid"),l.value=parseFloat(c).toString())}}),d&&(n.preventDefault(),alert("Vui lòng nhập giá hợp lệ (số dương)."));const a=(m==null?void 0:m.getElementsByClassName("variation-row"))||[];Array.from(a).forEach((l,c)=>{var s,p,f,y,b;(s=l.querySelector('input[name$="[name]"]'))==null||s.value,(p=l.querySelector('input[name$="[color_id]"]'))==null||p.value,(f=l.querySelector('input[name$="[size_id]"]'))==null||f.value,(y=l.querySelector('input[name$="[spherical_id]"]'))==null||y.value,(b=l.querySelector('input[name$="[cylindrical_id]"]'))==null||b.value})})}),E&&E.addEventListener("click",function(){const t=m.getElementsByClassName("variation-row");if(t.length===0){alert("Chưa có biến thể nào để thêm giá gốc.");return}const n=prompt("Nhập giá gốc cho tất cả biến thể (VD: 1000 hoặc 1234.56):");if(n===null)return;let e=n.replace(",",".").trim();if(!e||isNaN(parseFloat(e))||parseFloat(e)<0){alert("Vui lòng nhập giá gốc hợp lệ (số dương).");return}e=parseFloat(e).toString(),Array.from(t).forEach(r=>{const i=r.querySelector('input[name$="[price]"]');i&&(i.value=e,i.classList.remove("is-invalid"))})}),$&&$.addEventListener("click",function(){const t=m.getElementsByClassName("variation-row");if(t.length===0){alert("Chưa có biến thể nào để thêm giá khuyến mãi.");return}const n=prompt("Nhập giá khuyến mãi cho tất cả biến thể (VD: 900 hoặc 1234.56):");if(n===null)return;let e=n.replace(",",".").trim();if(!e||isNaN(parseFloat(e))||parseFloat(e)<0){alert("Vui lòng nhập giá khuyến mãi hợp lệ (số dương).");return}e=parseFloat(e).toString();let r=!1;Array.from(t).forEach(i=>{const o=i.querySelector('input[name$="[sale_price]"]');if(o){const u=i.querySelector('input[name$="[price]"]'),v=u?parseFloat(u.value.replace(",",".")):0;if(parseFloat(e)>v){alert(`Giá khuyến mãi (${e}) không được lớn hơn giá gốc (${v}) cho biến thể "${i.querySelector('input[name$="[name]"]').value}".`),r=!0;return}o.value=e,o.classList.remove("is-invalid")}})}),L(),q()});
