document.addEventListener("DOMContentLoaded",function(){const u=document.getElementById("product_type"),E=document.getElementById("simple-product"),$=document.getElementById("variable-product"),g=document.getElementById("name"),C=document.getElementById("simple_sku"),d=document.getElementById("variable_sku"),B=document.getElementById("simple_slug"),f=document.getElementById("variable_slug"),v=document.getElementById("simple_stock_quantity"),p=document.getElementById("variable_stock_quantity"),m=document.getElementById("attributes-container"),y=document.getElementById("add-attribute"),k=document.getElementById("generate-variations"),h=document.getElementById("variations-container"),S=window.colors||[],L=window.sizes||[];console.log("Colors loaded:",S),console.log("Sizes loaded:",L);function w(e,n=""){const t=Date.now(),l=`${n}${e.toLowerCase().replace(/\s+/g,"-")}-${t}`,i=`${n}${e.toLowerCase().replace(/\s+/g,"-")}-${t}`;return{sku:l,slug:i}}if(g&&C&&B&&d&&f&&g.addEventListener("input",function(){const{sku:e,slug:n}=w(this.value);C.value=e,B.value=n,d.value=`VAR-${e}`,f.value=`var-${n}`}),u){if(u.value==="simple")E.style.display="block",$.style.display="none";else if(E.style.display="none",$.style.display="block",g&&d&&f){const{sku:e,slug:n}=w(g.value,"VAR-");d.value=e,f.value=`var-${n}`}u.addEventListener("change",function(){const e=(v==null?void 0:v.value)||(p==null?void 0:p.value)||"0";if(this.value==="simple")E.style.display="block",$.style.display="none",v&&(v.value=e);else if(E.style.display="none",$.style.display="block",p&&(p.value=e),g&&d&&f){const{sku:n,slug:t}=w(g.value,"VAR-");d.value=n,f.value=`var-${t}`}})}[v,p].forEach(e=>{e&&e.addEventListener("blur",function(){(!this.value||isNaN(parseInt(this.value))||parseInt(this.value)<0)&&(this.value="0",console.log(`Set ${this.id} to default: 0`))})}),document.querySelectorAll(".price-input").forEach(e=>{e.addEventListener("input",function(n){let t=n.target.value.replace(/[^0-9,.]/g,"");t.includes(",")&&(t=t.replace(",",".")),t.split(".").length>2&&(t=t.replace(/\.+$/,"")),n.target.value=t}),e.addEventListener("blur",function(n){n.target.value===""&&(n.target.value="0",console.log("Set price/sale_price to default: 0"))})}),y&&y.addEventListener("click",function(){const e=m.getElementsByClassName("attribute-row");if(e.length>=2){y.style.display="none";return}const n=Array.from(e).map(s=>s.querySelector(".attribute-type").value),t=e.length,l=document.createElement("div");l.className="attribute-row row g-2 mb-2",l.innerHTML=`
                <div class="col-md-3">
                    <select name="attributes[${t}][type]" class="form-select attribute-type" data-index="${t}">
                        ${n.includes("color")?'<option value="size">Kích thước</option>':'<option value="color">Màu sắc</option>'}
                        ${!n.includes("size")&&!n.includes("color")?'<option value="size">Kích thước</option>':""}
                    </select>
                </div>
                <div class="col-md-6">
                    <div class="attribute-values-tags"></div>
                    <select class="form-select attribute-values" multiple>
                        <option value="">Chọn giá trị</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger btn-sm remove-attribute">Xóa</button>
                </div>
            `,m.appendChild(l);const i=l.querySelector(".attribute-type"),c=l.querySelector(".attribute-values-tags"),o=l.querySelector(".attribute-values");i.addEventListener("change",function(){c.innerHTML="",o.innerHTML='<option value="">Chọn giá trị</option>';const s=this.value==="color"?S:L;s&&s.length>0?(s.forEach(a=>{const r=document.createElement("option");r.value=a,r.text=a,o.appendChild(r)}),console.log(`Loaded ${this.value==="color"?S.length:L.length} options for ${this.value}`)):console.error(`No data available for ${this.value==="color"?"colors":"sizes"}`)}),o.addEventListener("change",function(){const s=Array.from(this.selectedOptions).map(a=>a.value).filter(a=>a);if(c.innerHTML="",s.forEach(a=>{const r=document.createElement("span");r.className="tag",r.innerHTML=`${a}<input type="hidden" name="attributes[${t}][values][]" value="${a}"><button type="button" class="remove-tag" data-value="${a}">×</button>`,c.appendChild(r)}),Array.from(this.options).forEach(a=>{s.includes(a.value)&&a.remove()}),!this.querySelector('option[value=""]')){const a=document.createElement("option");a.value="",a.text="Chọn giá trị",this.appendChild(a)}q(),b()}),c.addEventListener("click",function(s){if(s.target.classList.contains("remove-tag")){const a=s.target.getAttribute("data-value");s.target.parentElement.remove();const r=document.createElement("option");r.value=a,r.text=a,o.appendChild(r),q(),b()}}),l.querySelector(".remove-attribute").addEventListener("click",function(){l.remove(),q(),b()}),i.dispatchEvent(new Event("change")),b()});function b(){if(!m)return;const e=m.getElementsByClassName("attribute-row"),n=Array.from(e).map(t=>t.querySelector(".attribute-type").value);e.length>=2||n.includes("color")&&n.includes("size")?y.style.display="none":y.style.display=e.length<2?"block":"none"}function q(){if(!m)return;const e=m.getElementsByClassName("attribute-row");let n=!1;for(let t of e)if(t.querySelectorAll(".tag").length>0){n=!0;break}n?k.style.display="block":(k.style.display="none",h.style.display="none",h.innerHTML="")}function I(e){if(e.length===0)return[[]];const n=e[0],t=e.slice(1),l=I(t),i=[];for(let c of n.values)for(let o of l)i.push([c,...o]);return i}k&&k.addEventListener("click",function(){const e=m.getElementsByClassName("attribute-row"),n=[];for(let l of e){const i=l.querySelector(".attribute-type").value,c=l.querySelectorAll(".tag"),o=Array.from(c).map(s=>s.querySelector("input").value);o.length!==0&&n.push({type:i,values:o})}if(n.length===0){alert("Vui lòng chọn ít nhất một giá trị cho một thuộc tính.");return}const t=I(n);h.style.display="block",h.innerHTML="",t.forEach((l,i)=>{const c=document.createElement("div");c.className="variation-row row g-2 mb-2";const o=d.value,s=l.join(" - "),a=(Math.floor(Math.random()*400001)+1e5)/100,r=Math.floor(Math.random()*91)+10;c.innerHTML=`
                    <div class="col-md-2">
                        <input type="text" name="variations[${i}][name]" value="${s}" class="form-control" placeholder="Tên biến thể" readonly>
                    </div>
                    <div class="col-md-2">
                        <input type="text" name="variations[${i}][sku]" value="${o}-${s.toLowerCase().replace(/\s+/g,"-")}" class="form-control" placeholder="Mã sản phẩm">
                    </div>
                    <div class="col-md-2">
                        <input type="text" class="form-control price-input" name="variations[${i}][price]" value="${a}" placeholder="Nhập giá (VD: 1000 hoặc 1.234,56)">
                    </div>
                    <div class="col-md-2">
                        <input type="text" class="form-control price-input" name="variations[${i}][sale_price]" value="" placeholder="Nhập giá (VD: 900 hoặc 1.234,56)">
                    </div>
                    <div class="col-md-2">
                        <input type="number" name="variations[${i}][stock_quantity]" value="${r}" class="form-control" placeholder="Tồn kho" min="0">
                    </div>
                    <div class="col-md-1">
                        <select name="variations[${i}][status]" class="form-select">
                            <option value="in_stock">Còn hàng</option>
                            <option value="out_of_stock">Hết hàng</option>
                            <option value="hidden">Ẩn</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-danger btn-sm remove-variation">Xóa</button>
                    </div>
                `,h.appendChild(c),c.querySelector(".remove-variation").addEventListener("click",function(){c.remove()})})}),document.querySelectorAll("form").forEach(e=>{e.addEventListener("submit",function(n){const t=e.querySelector('input[name="price"]'),l=e.querySelector('input[name="sale_price"]'),i=e.querySelectorAll('input[name^="variations"][name$="[price]"]'),c=e.querySelectorAll('input[name^="variations"][name$="[sale_price]"]'),o=(u==null?void 0:u.value)==="simple"?v:p;let s=!1;if(o&&(!o.value||isNaN(parseInt(o.value))||parseInt(o.value)<0)?(o.value="0",console.log("Set stock_quantity to default on submit: 0")):o&&(o.value=parseInt(o.value).toString(),console.log("Stock quantity after validation:",o.value)),(u==null?void 0:u.value)==="simple"&&t&&t.value){let a=t.value.replace(",",".");isNaN(parseFloat(a))||parseFloat(a)<0?(t.classList.add("is-invalid"),s=!0):(t.classList.remove("is-invalid"),t.value=parseFloat(a).toString())}[l,...i,...c].forEach(a=>{if(a&&a.value){let r=a.value.replace(",",".");isNaN(parseFloat(r))||parseFloat(r)<0?(a.classList.add("is-invalid"),s=!0):(a.classList.remove("is-invalid"),a.value=parseFloat(r).toString())}}),console.log("Form data before submit:",{product_type:u==null?void 0:u.value,stock_quantity:o==null?void 0:o.value,price:t==null?void 0:t.value,sale_price:l==null?void 0:l.value}),s&&(n.preventDefault(),alert("Vui lòng nhập số lượng tồn kho và giá hợp lệ (số dương)."))})}),b()});
